<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervision Admin - Amma</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #1abc9c;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: white;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: white;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            border-radius: 8px;
            transition: all 0.3s ease;
            padding: 12px 15px;
        }

        .sidebar .nav-link:hover {
            color: white;
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            color: white;
            background: var(--primary-gradient);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .sidebar .nav-link i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        /* Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.25);
            background: rgba(255, 255, 255, 0.1);
        }

        .stat-card {
            color: white;
            padding: 20px;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .stat-card i {
            font-size: 2.5rem;
            opacity: 0.2;
            position: absolute;
            right: 20px;
            top: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover i {
            transform: scale(1.2);
            opacity: 0.3;
        }

        .bg-primary-custom {
            background: linear-gradient(135deg, var(--primary-color), #5a6fd3);
        }

        .bg-success-custom {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
        }

        .bg-warning-custom {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }

        .bg-danger-custom {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }

        .bg-info-custom {
            background: linear-gradient(135deg, var(--info-color), #16a085);
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            background: transparent;
        }

        /* Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            min-width: 90px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-enregistre {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            border: 1px solid #667eea;
        }

        .badge-transit {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .badge-livraison {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
            border: 1px solid #9b59b6;
        }

        .badge-livre {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid #2ecc71;
        }

        .badge-annule {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        /* Tables */
        .data-table {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .data-table:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .data-table .table {
            color: white;
            margin-bottom: 0;
        }

        .data-table .table th {
            border-top: none;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table .table td {
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
        }

        .data-table .table tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        /* User Avatar */
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Header */
        .page-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .page-title {
            font-weight: 700;
            color: white;
            font-size: 1.8rem;
        }

        .last-update {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Search Box */
        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 40px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            height: 40px;
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 10px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
                width: 100%;
            }
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar col-md-3 col-lg-2 d-md-block p-0">
        <div class="p-4">
            <h4 class="text-white mb-4 d-flex align-items-center">
                <i class="bi bi-shield-lock me-2 text-gradient" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                <span>Amma <span class="text-gradient" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Admin</span></span>
            </h4>
            <hr class="bg-light opacity-10 my-4">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/dashboard">
                        <i class="bi bi-speedometer2"></i> Tableau de bord
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/colis">
                        <i class="bi bi-box-seam"></i> Suivi des Colis
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/users">
                        <i class="bi bi-people"></i> Utilisateurs
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/livreurs">
                        <i class="bi bi-truck"></i> Livreurs
                    </a>
                </li>
                <li class="nav-item mt-3">
                    <a class="nav-link" href="/logout">
                        <i class="bi bi-box-arrow-right"></i> Déconnexion
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main content -->
    <div class="main-content col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <!-- Header -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 page-header">
            <div>
                <h2 class="page-title mb-2">
                    <i class="bi bi-speedometer2 me-2 text-primary"></i> Tableau de bord
                </h2>
                <div class="last-update">
                    <i class="bi bi-clock-history me-1"></i> Mis à jour: <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}"></span>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <span class="user-avatar" th:text="${#strings.substring(session.user.fullName, 0, 1)}"></span>
                    <span th:text="${session.user.fullName}"></span>
                </div>
            </div>
        </div>

        <!-- Statistiques principales -->
        <div class="row mb-4 animate-fade-in">
            <div class="col-md-4 mb-4">
                <div class="card stat-card bg-primary-custom">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Colis Totaux</h5>
                                <h2 th:text="${colisCount}">0</h2>
                                <small class="opacity-75">+5% depuis hier</small>
                            </div>
                            <i class="bi bi-box-seam"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card stat-card bg-success-custom">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Utilisateurs</h5>
                                <h2 th:text="${usersCount}">0</h2>
                                <small class="opacity-75">+2 nouveaux cette semaine</small>
                            </div>
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card stat-card bg-info-custom">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Livreurs Actifs</h5>
                                <h2 th:text="${livreursCount}">0</h2>
                                <small class="opacity-75">3 en mission</small>
                            </div>
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques des colis -->
        <div class="row mb-4 animate-fade-in" style="animation-delay: 0.1s;">
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-warning-custom">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">En Transit</h5>
                                <h2 th:text="${transitCount}">0</h2>
                            </div>
                            <i class="bi bi-arrow-repeat"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-purple" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">En Livraison</h5>
                                <h2 th:text="${livraisonCount}">0</h2>
                            </div>
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-success-custom">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Livrés</h5>
                                <h2 th:text="${livreCount}">0</h2>
                            </div>
                            <i class="bi bi-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-danger-custom">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Annulés</h5>
                                <h2 th:text="${annuleCount}">0</h2>
                            </div>
                            <i class="bi bi-x-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="row mb-4 animate-fade-in" style="animation-delay: 0.2s;">
            <div class="col-md-8">
                <div class="glass-card mb-4 p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Activité récente des colis</h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-sm btn-outline-light active">7 jours</button>
                            <button class="btn btn-sm btn-outline-light">30 jours</button>
                            <button class="btn btn-sm btn-outline-light">90 jours</button>
                        </div>
                    </div>
                    <canvas id="activityChart" height="250"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="glass-card p-4 h-100">
                    <h5 class="mb-3">Répartition des colis</h5>
                    <canvas id="pieChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Dernières activités -->
        <div class="row animate-fade-in" style="animation-delay: 0.3s;">
            <div class="col-md-6 mb-4">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Derniers colis</h5>
                        <div class="search-box">
                            <i class="bi bi-search"></i>
                            <input type="text" class="form-control form-control-sm" placeholder="Rechercher...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Code</th>
                                <th>Destinataire</th>
                                <th>Statut</th>
                                <th>Dernière MAJ</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="colis : ${recentColis}" style="cursor: pointer;" onclick="window.location.href='/admin/colis/details/' + ${colis.id}">
                                <td>
                                    <span class="badge bg-light text-dark">#<span th:text="${colis.codeSuivi}"></span></span>
                                </td>
                                <td th:text="${colis.destinataire}"></td>
                                <td>
                                    <span th:classappend="${colis.statut == T(com.example.colis.entity.StatutColis).ENREGISTRE} ? 'badge-enregistre' :
                                        ${colis.statut == T(com.example.colis.entity.StatutColis).EN_TRANSIT} ? 'badge-transit' :
                                        ${colis.statut == T(com.example.colis.entity.StatutColis).EN_LIVRAISON} ? 'badge-livraison' :
                                        ${colis.statut == T(com.example.colis.entity.StatutColis).LIVRE} ? 'badge-livre' : 'badge-annule'"
                                          class="status-badge" th:text="${colis.statut.label}"></span>
                                </td>
                                <td th:text="${#temporals.format(colis.dateMaj, 'dd/MM HH:mm')}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">Affichage des 5 derniers colis</small>
                        <a href="/admin/colis" class="btn btn-sm btn-outline-light">Voir tous <i class="bi bi-arrow-right ms-1"></i></a>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Derniers utilisateurs</h5>
                        <div class="search-box">
                            <i class="bi bi-search"></i>
                            <input type="text" class="form-control form-control-sm" placeholder="Rechercher...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Email</th>
                                <th>Rôle</th>
                                <th>Inscription</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="user : ${recentUsers}" style="cursor: pointer;" onclick="window.location.href='/admin/users/details/' + ${user.id}">
                                <td>
                                    <span class="user-avatar" th:text="${#strings.substring(user.fullName, 0, 1)}"></span>
                                    <span th:text="${user.fullName}"></span>
                                </td>
                                <td th:text="${user.email}"></td>
                                <td>
                                    <span th:if="${user.role == 'ADMIN'}" class="badge bg-primary">Admin</span>
                                    <span th:if="${user.role == 'LIVREUR'}" class="badge bg-warning">Livreur</span>
                                    <span th:if="${user.role == 'USER'}" class="badge bg-secondary">Client</span>
                                </td>
                                <td th:text="${#temporals.format(user.dateCreation, 'dd/MM/yyyy')}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">Affichage des 5 derniers utilisateurs</small>
                        <a href="/admin/users" class="btn btn-sm btn-outline-light">Voir tous <i class="bi bi-arrow-right ms-1"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);

        // S'abonner aux mises à jour d'un colis spécifique
        stompClient.subscribe('/topic/status/${colis.codeSuivi}', function(message) {
            const colis = JSON.parse(message.body);
            updatePackageStatus(colis);
        });

        // S'abonner aux notifications générales
        stompClient.subscribe('/topic/notifications', function(message) {
            showNotification(message.body);
        });
    });

    function updatePackageStatus(colis) {
        // Mettre à jour l'interface utilisateur avec les nouvelles données
        document.getElementById('status').innerText = colis.statut;
        // ... autres mises à jour
    }

    function showNotification(message) {
        // Afficher une notification à l'utilisateur
        alert(message);
    }

    // Pour envoyer une demande de suivi
    function trackPackage(code) {
        stompClient.send("/app/track", {}, code);
    }
    // Graphique d'activité
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            datasets: [
                {
                    label: 'Colis enregistrés',
                    data: [12, 19, 15, 22, 18, 5, 0],
                    borderColor: 'rgba(102, 126, 234, 1)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.3,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: 'Colis livrés',
                    data: [8, 12, 10, 15, 14, 3, 0],
                    borderColor: 'rgba(46, 204, 113, 1)',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.3,
                    fill: true,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(30, 30, 60, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    })

    // Graphique circulaire
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: ['Enregistré', 'En Transit', 'En Livraison', 'Livré', 'Annulé'],
            datasets: [{
                data: [
                    [[${enregistreCount}]],
                    [[${transitCount}]],
                    [[${livraisonCount}]],
                    [[${livreCount}]],
                    [[${annuleCount}]]
                ],
                backgroundColor: [
                    'rgba(102, 126, 234, 0.7)',
                    'rgba(243, 156, 18, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 30, 60, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '70%'
        }
    });

    // Animation au chargement
    document.addEventListener('DOMContentLoaded', function() {
        const elements = document.querySelectorAll('.animate-fade-in');
        elements.forEach((el, index) => {
            el.style.opacity = '0';
            setTimeout(() => {
                el.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
</script>
</body>
</html>