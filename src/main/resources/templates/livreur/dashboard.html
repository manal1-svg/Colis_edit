<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tableau de Bord Livreur - Amma Express</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root {
            --primary: #6c63ff;
            --secondary: #4d44db;
            --success: #28a745;
            --info: #17a2b8;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary) !important;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
            color: var(--primary);
        }

        .stat-card {
            border-left: 4px solid var(--primary);
        }

        .badge {
            padding: 6px 10px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }

        .btn-outline-primary {
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: white;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: #6c757d;
        }

        .table td {
            vertical-align: middle;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-in-progress {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-delivered {
            background-color: #d4edda;
            color: #155724;
        }

        .user-greeting {
            position: relative;
            padding-left: 15px;
        }

        .user-greeting:before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
            border-radius: 2px;
        }

        .action-btn {
            min-width: 120px;
            margin: 2px;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            z-index: 1;
        }

        .route-step {
            padding: 8px 12px;
            border-left: 3px solid var(--primary);
            margin-bottom: 5px;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-shipping-fast me-2"></i>AmmaExpress
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/livreur/dashboard"><i class="fas fa-tachometer-alt me-1"></i> Tableau de bord</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/suivi"><i class="fas fa-search-location me-1"></i> Suivi</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-danger" href="/logout"><i class="fas fa-sign-out-alt me-1"></i> Déconnexion</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-5">
    <!-- Bouton Retour -->
    <a href="/" class="btn btn-outline-primary mb-4">
        <i class="fas fa-arrow-left me-2"></i> Retour à l'accueil
    </a>

    <!-- Messages d'alerte -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div class="user-greeting">
            <h1 class="h3 mb-1">Bonjour, <span class="text-primary" th:text="${user.fullName}"></span></h1>
            <p class="text-muted mb-0">
                <i class="fas fa-user-tag me-1"></i>
                Livreur Amana Express
            </p>
        </div>
        <div>
            <span class="badge bg-primary me-2" th:text="${mesColis != null ? mesColis.size() + ' colis assignés' : '0 colis'}"></span>
            <span class="badge bg-secondary" th:text="${colisDisponibles != null ? colisDisponibles.size() + ' colis disponibles' : '0 colis'}"></span>
        </div>
    </div>

    <!-- Mes colis assignés -->
    <div class="card mb-5">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-box-open text-primary me-2"></i>
                Mes colis assignés
            </h5>
            <button id="optimizeRouteBtn" class="btn btn-primary btn-sm">
                <i class="fas fa-route me-1"></i>Optimiser l'itinéraire
            </button>
        </div>
        <div class="card-body">
            <div th:if="${mesColis != null and !mesColis.isEmpty()}">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Code Suivi</th>
                            <th>Destinataire</th>
                            <th>Adresse</th>
                            <th>Poids</th>
                            <th>Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="colis : ${mesColis}">
                            <td>
                                <span class="fw-bold" th:text="${colis.codeSuivi}"></span>
                            </td>
                            <td th:text="${colis.destinataire}"></td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" th:text="${colis.adresseLivraison}"></div>
                            </td>
                            <td th:text="${colis.poids} + ' kg'"></td>
                            <td>
                                    <span th:switch="${colis.statut}" class="status-badge">
                                        <span th:case="EN_ATTENTE" class="status-pending">En attente</span>
                                        <span th:case="EN_COURS" class="status-in-progress">En cours</span>
                                        <span th:case="LIVRE" class="status-delivered">Livré</span>
                                    </span>
                            </td>
                            <td class="text-end">
                                <div class="d-flex flex-wrap justify-content-end">
                                    <form th:action="@{/livreur/colis/en-livraison/} + ${colis.id}" method="post">
                                        <button type="submit" class="btn btn-info action-btn">
                                            <i class="fas fa-truck me-1"></i> En livraison
                                        </button>
                                    </form>
                                    <form th:action="@{/livreur/colis/livrer/} + ${colis.id}" method="post">
                                        <button type="submit" class="btn btn-success action-btn">
                                            <i class="fas fa-check me-1"></i> Livré
                                        </button>
                                    </form>
                                    <form th:action="@{/livreur/colis/refuser/} + ${colis.id}" method="post"
                                          onsubmit="return confirm('Êtes-vous sûr de vouloir refuser ce colis ?')">
                                        <button type="submit" class="btn btn-danger action-btn">
                                            <i class="fas fa-times me-1"></i> Refuser
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div th:if="${mesColis == null or mesColis.isEmpty()}" class="text-center py-5">
                <i class="fas fa-box-open text-muted fs-1 mb-3"></i>
                <h5 class="text-muted mb-3">Aucun colis assigné</h5>
            </div>
        </div>
    </div>

    <!-- Colis disponibles -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-boxes text-primary me-2"></i>
                Colis disponibles
            </h5>
        </div>
        <div class="card-body">
            <div th:if="${colisDisponibles != null and !colisDisponibles.isEmpty()}">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Code Suivi</th>
                            <th>Destinataire</th>
                            <th>Adresse</th>
                            <th>Poids</th>
                            <th class="text-end">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="colis : ${colisDisponibles}">
                            <td>
                                <span class="fw-bold" th:text="${colis.codeSuivi}"></span>
                            </td>
                            <td th:text="${colis.destinataire}"></td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" th:text="${colis.adresseLivraison}"></div>
                            </td>
                            <td th:text="${colis.poids} + ' kg'"></td>
                            <td class="text-end">
                                <form th:action="@{/livreur/colis/accepter/} + ${colis.id}" method="post">
                                    <button type="submit" class="btn btn-primary action-btn">
                                        <i class="fas fa-check me-1"></i> Accepter
                                    </button>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div th:if="${colisDisponibles == null or colisDisponibles.isEmpty()}" class="text-center py-5">
                <i class="fas fa-boxes text-muted fs-1 mb-3"></i>
                <h5 class="text-muted mb-3">Aucun colis disponible</h5>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour l'optimisation d'itinéraire -->
<div class="modal fade" id="optimisationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-route me-2"></i>Optimisation d'itinéraire
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="map"></div>
                <div class="mt-3">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="trafficToggle" checked>
                        <label class="form-check-label" for="trafficToggle">Prendre en compte le trafic</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="weatherToggle">
                        <label class="form-check-label" for="weatherToggle">Prendre en compte la météo</label>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Itinéraire optimisé :</h6>
                    <div id="routeInstructions" class="list-group"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="startNavigation">
                    <i class="fas fa-play me-1"></i>Commencer la tournée
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);

        // S'abonner aux mises à jour d'un colis spécifique
        stompClient.subscribe('/topic/status/${colis.codeSuivi}', function(message) {
        const colis = JSON.parse(message.body);
        updatePackageStatus(colis);
    });

        // S'abonner aux notifications générales
        stompClient.subscribe('/topic/notifications', function(message) {
        showNotification(message.body);
    });
    });

        function updatePackageStatus(colis) {
        // Mettre à jour l'interface utilisateur avec les nouvelles données
        document.getElementById('status').innerText = colis.statut;
        // ... autres mises à jour
    }

        function showNotification(message) {
        // Afficher une notification à l'utilisateur
        alert(message);
    }

        // Pour envoyer une demande de suivi
        function trackPackage(code) {
        stompClient.send("/app/track", {}, code);
    }
    // Variables globales
    let map;
    let routeLayer;
    let markers = [];
    const ORS_API_KEY = '5b3ce3597851110001cf6248cb864e9e9f84496b9e1219b0d95134df';

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Bouton pour ouvrir l'optimisation
        document.getElementById('optimizeRouteBtn').addEventListener('click', initOptimization);

        // Bouton de navigation
        document.getElementById('startNavigation').addEventListener('click', function() {
            alert('Navigation démarrée! Suivez les instructions de l\'itinéraire.');
        });
    });

    // Initialisation de l'optimisation
    function initOptimization() {
        const modal = new bootstrap.Modal(document.getElementById('optimisationModal'));
        modal.show();

        // Initialiser la carte après l'ouverture du modal
        document.getElementById('optimisationModal').addEventListener('shown.bs.modal', function() {
            initMap();
            loadColisForOptimization();
        });
    }

    // Initialiser la carte Leaflet
    function initMap() {
        if (!map) {
            map = L.map('map').setView([33.5731, -7.5898], 12); // Coordonnées par défaut (Casablanca)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        } else {
            map.eachLayer(layer => {
                if (layer !== routeLayer) {
                    map.removeLayer(layer);
                }
            });
            markers = [];
        }
    }

    // Charger les colis pour optimisation
    function loadColisForOptimization() {
        const colisAssignes = [];
        document.querySelectorAll('#mesColisTable tbody tr').forEach(row => {
            const cols = row.querySelectorAll('td');
            if (cols.length >= 3) {
                colisAssignes.push({
                    code: cols[0].textContent.trim(),
                    adresse: cols[2].textContent.trim(),
                    statut: cols[4].textContent.trim()
                });
            }
        });

        if (colisAssignes.length > 0) {
            geocodeAddresses(colisAssignes);
        } else {
            alert('Aucun colis assigné à optimiser');
        }
    }

    // Géocodage des adresses
    async function geocodeAddresses(colisList) {
        try {
            const coordinates = [];

            for (const colis of colisList) {
                if (colis.statut !== 'Livré') { // Ne pas inclure les colis déjà livrés
                    const response = await axios.get(
                        `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(colis.adresse)}`
                    );

                    if (response.data.features.length > 0) {
                        const [lon, lat] = response.data.features[0].geometry.coordinates;
                        coordinates.push({
                            lon: lon,
                            lat: lat,
                            code: colis.code,
                            adresse: colis.adresse
                        });

                        // Ajouter un marqueur sur la carte
                        const marker = L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<b>${colis.code}</b><br>${colis.adresse}`);
                        markers.push(marker);
                    }
                }
            }

            // Optimiser l'itinéraire si on a au moins 2 points
            if (coordinates.length > 1) {
                const optimizedRoute = await optimizeRoute(coordinates);
                displayRoute(optimizedRoute);
            } else if (coordinates.length === 1) {
                map.setView([coordinates[0].lat, coordinates[0].lon], 15);
                alert('Un seul colis à livrer - pas d\'optimisation nécessaire');
            }

        } catch (error) {
            console.error("Erreur de géocodage :", error);
            alert("Erreur lors de l'optimisation de l'itinéraire");
        }
    }

    // Optimiser l'itinéraire
    async function optimizeRoute(points) {
        try {
            // Convertir les points en format OpenRouteService
            const coordinates = points.map(p => [p.lon, p.lat]);

            // Construction du corps de la requête
            const requestBody = {
                locations: coordinates,
                geometry: true,
                instructions: true,
                preference: 'shortest'
            };

            // Appel à l'API OpenRouteService
            const response = await axios.post(
                `https://api.openrouteservice.org/v2/directions/driving-car/geojson`,
                requestBody,
                {
                    headers: {
                        'Authorization': ORS_API_KEY,
                        'Content-Type': 'application/json'
                    }
                }
            );

            return response.data;

        } catch (error) {
            console.error("Erreur d'optimisation :", error);
            throw error;
        }
    }

    // Afficher l'itinéraire sur la carte
    function displayRoute(routeData) {
        // Nettoyer la couche précédente
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }

        // Convertir les coordonnées pour Leaflet
        const coordinates = routeData.features[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);

        // Afficher la ligne de l'itinéraire
        routeLayer = L.polyline(coordinates, {
            color: '#6c63ff',
            weight: 5,
            opacity: 0.7
        }).addTo(map);

        // Ajuster la vue de la carte
        map.fitBounds(routeLayer.getBounds());

        // Afficher les instructions
        const instructionsContainer = document.getElementById('routeInstructions');
        instructionsContainer.innerHTML = '';

        routeData.features[0].properties.segments[0].steps.forEach((step, index) => {
            const instruction = document.createElement('div');
            instruction.className = 'list-group-item route-step';
            instruction.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">Étape ${index + 1}</small>
                    <div>${step.instruction}</div>
                </div>
                <span class="badge bg-primary">${(step.distance/1000).toFixed(1)} km</span>
            </div>
        `;
            instructionsContainer.appendChild(instruction);
        });

        // Estimation du temps avec facteurs externes
        estimateDeliveryTime(routeData);
    }

    // Estimation du temps optimal avec facteurs externes
    function estimateDeliveryTime(routeData) {
        const totalDistance = routeData.features[0].properties.segments[0].distance;
        const totalDuration = routeData.features[0].properties.segments[0].duration;

        // Facteurs d'ajustement
        const trafficFactor = document.getElementById('trafficToggle').checked ? 1.3 : 1;
        const weatherFactor = document.getElementById('weatherToggle').checked ? 1.2 : 1;

        // Calcul du temps estimé (en minutes)
        const baseTime = totalDuration / 60;
        const adjustedTime = baseTime * trafficFactor * weatherFactor;

        // Calcul de l'heure d'arrivée
        const now = new Date();
        const arrivalTime = new Date(now.getTime() + adjustedTime * 60000);

        // Affichage dans une nouvelle étape
        const instructionsContainer = document.getElementById('routeInstructions');
        const summary = document.createElement('div');
        summary.className = 'list-group-item bg-light';
        summary.innerHTML = `
        <div class="fw-bold">Résumé de l'itinéraire</div>
        <div class="d-flex justify-content-between mt-2">
            <div>
                <small class="text-muted">Distance totale</small>
                <div>${(totalDistance/1000).toFixed(1)} km</div>
            </div>
            <div>
                <small class="text-muted">Temps estimé</small>
                <div>${Math.round(adjustedTime)} minutes</div>
            </div>
            <div>
                <small class="text-muted">Arrivée prévue</small>
                <div>${arrivalTime.toLocaleTimeString()}</div>
            </div>
        </div>
    `;
        instructionsContainer.prepend(summary);
    }
</script>
</body>
</html>